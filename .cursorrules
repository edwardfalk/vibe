# .cursorrules

> Purpose: keep Vibe modular, playable, and easy for the next AI agent to continue.

---

## 1) Architecture (source of truth)

- Use strict modular architecture under `js/`.
- `ARCHITECTURE.md` is the architecture source of truth (module inventory + migration state).
- Do not reintroduce legacy/monolithic files.
- Prefer domain folders for new/refactored files:
  - `js/core/`, `js/systems/`, `js/entities/`, `js/audio/`, `js/effects/`, `js/shared/`, `js/testing/`
- Legacy files that must stay unused:
  - `js/game.js`
  - `js/enemy.js`
  - `js/explosion.js`

---

## 2) Runtime Scope

- Built-in ticketing/bug-report runtime is removed.
- Do not add dependencies on removed systems (`ticket-api.js`, `ticketManager.js`, `move-bug-reports.js`).
- Keep gameplay runtime independent of backend services.

---

## 3) JavaScript Standards

- Prefer simple, readable code over clever code.
- Use early returns to reduce nesting.
- Use descriptive names (`handle*` prefix for handlers).
- Prefer `const` unless reassignment is required.
- Use ES modules (`import`/`export`).
- Add concise function-level comments only when behavior is non-obvious.
- Keep modules focused; split files that exceed ~500 lines and hold multiple responsibilities.

### Error handling

- Guard optional globals before use.
- External/integration calls should fail safely with clear logs.
- Avoid silent failures.

### Logging

- Use emoji-prefixed logs for runtime diagnostics:
  - `üéÆ` game state
  - `üéµ` audio
  - `üéØ` AI behavior
  - `üó°Ô∏è` combat
  - `üöÄ` movement
  - `üí•` explosion/effects
  - `‚ö†Ô∏è` errors/warnings

---

## 4) p5.js + Math Rules

- This project uses p5.js instance mode.
- Use `p.` / `this.p.` for p5 APIs and constants.
- Import math helpers from `mathUtils.js`; avoid implicit p5 global math.

---

## 5) Enemy Consistency Contracts

- Enemy constructor signature must stay:
  - `constructor(x, y, type, config, p, audio)`
- Enemy update methods must accept `deltaTimeMs`.
- Attack methods must return structured objects or `null` (never bare booleans).

---

## 6) Timing Rules

- Use `deltaTimeMs` for movement/animation/behavior timing.
- Normalize to 60fps baseline where needed:
  - `const dt = deltaTimeMs / 16.6667`
- Use BeatClock for musical synchronization logic.

---

## 7) Testing Rules

- Keep automated testing probe-driven.
- Primary smoke path:
  - `bun run test:mcp`
- Gameplay probes should validate real runtime behavior (not mocked placeholders).
- On failures, capture screenshot + diagnostics in test artifacts.

---

## 8) Tooling + Workflow

- `dev` should run frontend server only.
- Keep startup robust if port 5500 is busy.
- Update docs when architecture or workflow changes.
- Remove stale docs/scripts quickly to reduce agent confusion.

---

## 9) Keep It Clean

- Avoid magic numbers where practical; extract constants.
- Refactor when local complexity grows.
- Minimize unrelated changes in each patch.
- Optimize for the next stateless AI agent reading this repo.
